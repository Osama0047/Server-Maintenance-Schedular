{% extends "base.html" %}

{% block title %}Servers - Server Maintenance Scheduler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-server me-2"></i>
                Server Management
            </h1>
            <div class="btn-group">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServerModal">
                    <i class="fas fa-plus me-2"></i>Add Server
                </button>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importServerModal">
                    <i class="fas fa-upload me-2"></i>Import Servers
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Servers Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Registered Servers</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="serversTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Hostname</th>
                                <th>IP Address</th>
                                <th>Status</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="serversTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Server Modal -->
<div class="modal fade" id="addServerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Server</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addServerForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="serverName" class="form-label">Server Name *</label>
                        <input type="text" class="form-control" id="serverName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="serverHostname" class="form-label">Hostname *</label>
                        <input type="text" class="form-control" id="serverHostname" name="hostname" required>
                    </div>
                    <div class="mb-3">
                        <label for="serverIpAddress" class="form-label">IP Address *</label>
                        <input type="text" class="form-control" id="serverIpAddress" name="ip_address" required 
                               pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" 
                               title="Please enter a valid IP address">
                    </div>
                    <div class="mb-3">
                        <label for="serverDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="serverDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Server</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Server Modal -->
<div class="modal fade" id="editServerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Server</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editServerForm">
                <input type="hidden" id="editServerId" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editServerName" class="form-label">Server Name *</label>
                        <input type="text" class="form-control" id="editServerName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editServerHostname" class="form-label">Hostname *</label>
                        <input type="text" class="form-control" id="editServerHostname" name="hostname" required>
                    </div>
                    <div class="mb-3">
                        <label for="editServerIpAddress" class="form-label">IP Address *</label>
                        <input type="text" class="form-control" id="editServerIpAddress" name="ip_address" required 
                               pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" 
                               title="Please enter a valid IP address">
                    </div>
                    <div class="mb-3">
                        <label for="editServerStatus" class="form-label">Status</label>
                        <select class="form-control" id="editServerStatus" name="status">
                            <option value="online">Online</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editServerDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editServerDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Servers Modal -->
<div class="modal fade" id="importServerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Servers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <h6>Supported Formats:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-file-csv text-success me-2"></i><strong>CSV</strong> - Comma-separated values</li>
                            <li><i class="fas fa-file-code text-info me-2"></i><strong>JSON</strong> - JavaScript Object Notation</li>
                        </ul>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h6>CSV Format Example:</h6>
                        <pre class="bg-light p-2 rounded"><code>name,hostname,ip_address,description
Web Server 1,web01.example.com,192.168.1.10,Production web server
Database Server,db01.example.com,192.168.1.20,Primary database server
API Server,api01.example.com,192.168.1.30,REST API server</code></pre>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h6>JSON Format Example:</h6>
                        <pre class="bg-light p-2 rounded"><code>[
  {
    "name": "Web Server 1",
    "hostname": "web01.example.com",
    "ip_address": "192.168.1.10",
    "description": "Production web server"
  },
  {
    "name": "Database Server",
    "hostname": "db01.example.com",
    "ip_address": "192.168.1.20",
    "description": "Primary database server"
  }
]</code></pre>
                    </div>
                </div>
                
                <form id="importServerForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="serverFile" class="form-label">Select File *</label>
                        <input type="file" class="form-control" id="serverFile" name="file" 
                               accept=".csv,.json" required>
                        <div class="form-text">Choose a CSV or JSON file containing server information</div>
                    </div>
                    
                    <div id="importPreview" class="mb-3" style="display: none;">
                        <h6>Import Preview:</h6>
                        <div id="previewContent" class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                </form>
                
                <div id="importResults" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Import Results:</h6>
                        <div id="importSummary"></div>
                        <div id="importErrors" style="display: none;">
                            <strong>Errors:</strong>
                            <ul id="errorList"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="previewImport()" id="previewBtn">
                    <i class="fas fa-eye me-1"></i>Preview
                </button>
                <button type="submit" form="importServerForm" class="btn btn-primary" id="importBtn" disabled>
                    <i class="fas fa-upload me-1"></i>Import Servers
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadServers();
    
    // Add server form submission
    $('#addServerForm').submit(function(e) {
        e.preventDefault();
        addServer();
    });
    
    // Edit server form submission
    $('#editServerForm').submit(function(e) {
        e.preventDefault();
        updateServer();
    });
    
    // Import server form submission
    $('#importServerForm').submit(function(e) {
        e.preventDefault();
        importServers();
    });
    
    // File selection handler
    $('#serverFile').change(function() {
        const file = this.files[0];
        if (file) {
            $('#previewBtn').prop('disabled', false);
            $('#importResults').hide();
            $('#importPreview').hide();
        } else {
            $('#previewBtn').prop('disabled', true);
            $('#importBtn').prop('disabled', true);
        }
    });
});

function loadServers() {
    $.get('/api/servers', function(data) {
        let html = '';
        
        if (data.length === 0) {
            html = '<tr><td colspan="6" class="text-center text-muted">No servers registered</td></tr>';
        } else {
            data.forEach(function(server) {
                let statusClass = getStatusClass(server.status);
                let statusIcon = getStatusIcon(server.status);
                
                html += `
                    <tr>
                        <td><strong>${server.name}</strong></td>
                        <td>${server.hostname}</td>
                        <td>${server.ip_address}</td>
                        <td>
                            <span class="badge ${statusClass}">
                                <i class="${statusIcon} me-1"></i>${server.status}
                            </span>
                        </td>
                        <td>${server.description || '-'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editServer(${server.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteServer(${server.id}, '${server.name}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }
        
        $('#serversTableBody').html(html);
    }).fail(function() {
        $('#serversTableBody').html('<tr><td colspan="6" class="text-center text-danger">Failed to load servers</td></tr>');
    });
}

function addServer() {
    const formData = {
        name: $('#serverName').val(),
        hostname: $('#serverHostname').val(),
        ip_address: $('#serverIpAddress').val(),
        description: $('#serverDescription').val()
    };
    
    $.ajax({
        url: '/api/servers',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(data) {
            $('#addServerModal').modal('hide');
            $('#addServerForm')[0].reset();
            loadServers();
            showAlert('Server added successfully!', 'success');
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to add server';
            showAlert(error, 'danger');
        }
    });
}

function editServer(serverId) {
    $.get(`/api/servers/${serverId}`, function(server) {
        $('#editServerId').val(server.id);
        $('#editServerName').val(server.name);
        $('#editServerHostname').val(server.hostname);
        $('#editServerIpAddress').val(server.ip_address);
        $('#editServerStatus').val(server.status);
        $('#editServerDescription').val(server.description);
        
        $('#editServerModal').modal('show');
    }).fail(function() {
        showAlert('Failed to load server details', 'danger');
    });
}

function updateServer() {
    const serverId = $('#editServerId').val();
    const formData = {
        name: $('#editServerName').val(),
        hostname: $('#editServerHostname').val(),
        ip_address: $('#editServerIpAddress').val(),
        status: $('#editServerStatus').val(),
        description: $('#editServerDescription').val()
    };
    
    $.ajax({
        url: `/api/servers/${serverId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(data) {
            $('#editServerModal').modal('hide');
            loadServers();
            showAlert('Server updated successfully!', 'success');
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to update server';
            showAlert(error, 'danger');
        }
    });
}

function deleteServer(serverId, serverName) {
    if (confirm(`Are you sure you want to delete server "${serverName}"? This will also cancel any scheduled maintenance for this server.`)) {
        $.ajax({
            url: `/api/servers/${serverId}`,
            method: 'DELETE',
            success: function() {
                loadServers();
                showAlert('Server deleted successfully!', 'success');
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to delete server';
                showAlert(error, 'danger');
            }
        });
    }
}

function getStatusClass(status) {
    switch(status) {
        case 'online': return 'bg-success';
        case 'maintenance': return 'bg-warning text-dark';
        case 'offline': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getStatusIcon(status) {
    switch(status) {
        case 'online': return 'fas fa-check-circle';
        case 'maintenance': return 'fas fa-tools';
        case 'offline': return 'fas fa-times-circle';
        default: return 'fas fa-question-circle';
    }
}

function previewImport() {
    const fileInput = $('#serverFile')[0];
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Please select a file first', 'warning');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            let previewData = [];
            
            if (file.name.endsWith('.csv')) {
                previewData = parseCSVPreview(content);
            } else if (file.name.endsWith('.json')) {
                previewData = parseJSONPreview(content);
            }
            
            if (previewData.length > 0) {
                displayPreview(previewData);
                $('#importBtn').prop('disabled', false);
            } else {
                showAlert('No valid server data found in file', 'warning');
            }
            
        } catch (error) {
            showAlert('Error reading file: ' + error.message, 'danger');
        }
    };
    
    reader.readAsText(file);
}

function parseCSVPreview(content) {
    const lines = content.trim().split('\n');
    if (lines.length < 2) return [];
    
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    const data = [];
    
    for (let i = 1; i < Math.min(lines.length, 6); i++) { // Preview first 5 rows
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        
        headers.forEach((header, index) => {
            row[header] = values[index] || '';
        });
        
        if (row.name && row.hostname && row.ip_address) {
            data.push(row);
        }
    }
    
    return data;
}

function parseJSONPreview(content) {
    try {
        const data = JSON.parse(content);
        const servers = Array.isArray(data) ? data : [data];
        return servers.slice(0, 5); // Preview first 5 servers
    } catch (error) {
        throw new Error('Invalid JSON format');
    }
}

function displayPreview(data) {
    let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Hostname</th><th>IP Address</th><th>Description</th></tr></thead><tbody>';
    
    data.forEach(server => {
        html += `
            <tr>
                <td>${server.name || '-'}</td>
                <td>${server.hostname || '-'}</td>
                <td>${server.ip_address || '-'}</td>
                <td>${server.description || '-'}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    
    if (data.length === 5) {
        html += '<p class="text-muted text-center"><small>Showing first 5 rows...</small></p>';
    }
    
    $('#previewContent').html(html);
    $('#importPreview').show();
}

function importServers() {
    const fileInput = $('#serverFile')[0];
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Please select a file', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Disable import button and show loading
    $('#importBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Importing...');
    
    $.ajax({
        url: '/api/servers/import',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            displayImportResults(response);
            loadServers(); // Refresh the server list
            
            // Reset form after successful import
            if (response.success_count > 0) {
                $('#importServerForm')[0].reset();
                $('#importPreview').hide();
                setTimeout(() => {
                    $('#importServerModal').modal('hide');
                }, 3000);
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to import servers';
            showAlert(error, 'danger');
        },
        complete: function() {
            $('#importBtn').prop('disabled', false).html('<i class="fas fa-upload me-1"></i>Import Servers');
        }
    });
}

function displayImportResults(response) {
    let summaryHtml = `
        <strong>Import completed:</strong><br>
        ✅ Successfully imported: ${response.success_count} servers<br>
        ${response.error_count > 0 ? `❌ Errors: ${response.error_count}` : ''}
    `;
    
    $('#importSummary').html(summaryHtml);
    
    if (response.errors && response.errors.length > 0) {
        let errorHtml = '';
        response.errors.forEach(error => {
            errorHtml += `<li>${error}</li>`;
        });
        $('#errorList').html(errorHtml);
        $('#importErrors').show();
    } else {
        $('#importErrors').hide();
    }
    
    $('#importResults').show();
    
    if (response.success_count > 0) {
        showAlert(response.message, 'success');
    }
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('.container-fluid').prepend(alertHtml);
    
    setTimeout(function() {
        $('.alert').alert('close');
    }, 5000);
}
</script>
{% endblock %} 